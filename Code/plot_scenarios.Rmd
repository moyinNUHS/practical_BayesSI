---
title: "Plots for simulation scenarios"
author: "Mo Yin"
date: "2023-09-08"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# clean environment 
rm(list = ls())

# set working directory to the `practical/` folder 
wd = '/Users/cheryl/Documents/duke-nus/bibhas/practical/practical/'
#wd = '~/Documents/GitHub/practical/'
setwd(wd)

# load libraries and functions
scripts = paste0(wd, 'Code/Functions/', list.files(paste0(wd, 'Code/Functions/')))
lapply(scripts, source)

# load data in the output folder 
files = list.files(path = paste0(wd, 'Code/Run_output'), full.names = TRUE, pattern = "100_2023-09-18*.rds")
files = files[-grep('power_|t1_', files)]
outputs = list()
for (file in files){
  outputs[[sub('.*/', '', file)]] = readRDS(file)
}

# get names of methods
all_names = names(outputs[[1]][[1]]$scenario_out[[1]])
all_method_names = all_names[grep('method', all_names)]

method_labs = rep(NA, length(all_method_names))
method_labs[grep('method_1', all_method_names)] = "Fixed-effect (frequentist)"
method_labs[grep('method_1_', all_method_names)] = "Fixed-effect (Bayesian, "
method_labs[grep('method_2', all_method_names)] = "Mixed-effect (frequentist)"
method_labs[grep('method_2_', all_method_names)] = "Mixed-effect (Bayesian, "
method_labs[grep('NI', all_method_names)] = paste0(method_labs[grep('NI', all_method_names)], 'non-informative prior)')
method_labs[endsWith(all_method_names, 'str')] = paste0(method_labs[endsWith(all_method_names, 'str')], 'strongly-informative prior)')
method_labs[endsWith(all_method_names, 'wk')] = paste0(method_labs[endsWith(all_method_names, 'wk')], 'weakly-informative prior)')
method_labs[endsWith(all_method_names, 'str_ur1')] = paste0(method_labs[endsWith(all_method_names, 'str_ur1')], 'strongly-informative/UR1 prior)')
method_labs[endsWith(all_method_names, 'str_ur2')] = paste0(method_labs[endsWith(all_method_names, 'str_ur2')], 'strongly-informative/UR2 prior)')
method_labs[endsWith(all_method_names, 'wk_ur1')] = paste0(method_labs[endsWith(all_method_names, 'wk_ur1')], 'weakly-informative/UR1 prior)')
method_labs[endsWith(all_method_names, 'wk_ur2')] = paste0(method_labs[endsWith(all_method_names, 'wk_ur2')], 'weakly-informative/UR2 prior)')

# define colors and shapes 
n_methods = length(method_labs)
shapes = 1:n_methods
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
colors_list = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals))) 
colors = sample(colors_list, n_methods)
names(shapes) = names(colors) = method_labs

font_size = 24
```
## Final analysis report {.tabset .tabset-fade .tabset-pills}

### Bias, Coverage, MSE

Each point from left to right for each method represents a performance measure of an estimated \ncontrast between treatments 2, 3, and 4 relative to treatment 1.

#### Scenario 1.1

```{r, echo = FALSE, fig.align="center", fig.height = 14, fig.width = 18}

ind1.1 = grep('1.1', files)
if (length(ind1.1) == 1) {
  f = plot_biasmse(Scenario = '1.1', d = outputs[[ind1.1]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/biasmse_scenario1.1_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```


#### Scenario 1.2
Treatment B is better than treatments A, C and D: 
$T_B = 35\%$; and 
$T_j = 45\%$, $j = A, C, D$

```{r, echo = FALSE, fig.align="center",fig.height = 14, fig.width = 18}

ind1.2 = grep('1.2', files)
if (length(ind1.2) == 1) {
  f = plot_biasmse(Scenario = '1.2', d = outputs[[ind1.2]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}



#ggsave(paste0(wd,"Code/Plots/biasmse_scenario1.2_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 1.3
All 4 treatments have different effects (small difference):
$T_A = 30\%$; $T_B = 35\%$; $T_C = 40\%$; $T_D = 45\%$

```{r, echo = FALSE, fig.align="center", fig.height = 14, fig.width = 18}

ind1.3 = grep('1.3', files)
if (length(ind1.3) == 1) {
  f = plot_biasmse(Scenario = '1.3', d = outputs[[ind1.3]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/biasmse_scenario1.3_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 1.4

```{r, echo = FALSE, fig.align="center", fig.height = 14, fig.width = 18}

ind1.4 = grep('1.4', files)
if (length(ind1.4) == 1) {
  f = plot_biasmse(Scenario = '1.4', d = outputs[[ind1.4]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/biasmse_scenario1.1_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 2.1

```{r, echo = FALSE, fig.align="center", fig.height = 14, fig.width = 18}

ind2.1 = grep('2.1', files)
if (length(ind2.1) == 1) {
  f = plot_biasmse(Scenario = '2.1', d = outputs[[ind2.1]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/biasmse_scenario1.1_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 2.2

```{r, echo = FALSE, fig.align="center", fig.height = 14, fig.width = 18}

ind2.2 = grep('2.2', files)
if (length(ind2.2) == 1) {
  f = plot_biasmse(Scenario = '2.2', d = outputs[[ind2.2]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/biasmse_scenario1.1_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 2.3

```{r, echo = FALSE, fig.align="center", fig.height = 14, fig.width = 18}

ind2.3 = grep('2.3', files)
if (length(ind2.3) == 1) {
  f = plot_biasmse(Scenario = '2.3', d = outputs[[ind2.3]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/biasmse_scenario1.1_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 3.1

```{r, echo = FALSE, fig.align="center", fig.height = 14, fig.width = 18}

ind3.1 = grep('3.1', files)
if (length(ind3.1) == 1) {
  f = plot_biasmse(Scenario = '3.1', d = outputs[[ind3.1]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/biasmse_scenario1.1_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 3.2

```{r, echo = FALSE, fig.align="center", fig.height = 14, fig.width = 18}

ind3.2 = grep('3.2', files)
if (length(ind3.2) == 1) {
  f = plot_biasmse(Scenario = '3.2', d = outputs[[ind3.2]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/biasmse_scenario1.1_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 4.1

```{r, echo = FALSE, fig.align="center", fig.height = 14, fig.width = 18}

ind4.1 = grep('4.1', files)
if (length(ind4.1) == 1) {
  f = plot_biasmse(Scenario = '4.1', d = outputs[[ind4.1]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/biasmse_scenario1.1_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```


#### Scenario 4.2

```{r, echo = FALSE, fig.align="center", fig.height = 14, fig.width = 18}

ind4.2 = grep('4.2', files)
if (length(ind4.2) == 1) {
  f = plot_biasmse(Scenario = '4.2', d = outputs[[ind4.2]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/biasmse_scenario1.1_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 4.3

```{r, echo = FALSE, fig.align="center", fig.height = 14, fig.width = 18}

ind4.3 = grep('4.3', files)
if (length(ind4.3) == 1) {
  f = plot_biasmse(Scenario = '4.3', d = outputs[[ind4.3]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/biasmse_scenario1.1_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

### Mortality gain

#### Scenario 1.2
Treatment B is better than treatments A, C and D: 
$T_B = 35\%$; and 
$T_j = 45\%$, $j = A, C, D$

```{r, echo = FALSE, fig.align="center",fig.height = 12, fig.width = 12}

ind1.2 = grep('1.2', files)
if (length(ind1.2) == 1) {
  f = plot_mort(Scenario = '1.2', d = outputs[[ind1.2]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/mort_scenario1.2_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 1.3
All 4 treatments have different effects (small difference):
$T_A = 30\%$; $T_B = 35\%$; $T_C = 40\%$; $T_D = 45\%$

```{r, echo = FALSE, fig.align="center",fig.height = 12, fig.width = 12}

ind1.3 = grep('1.3', files)
if (length(ind1.3) == 1) {
  f = plot_mort(Scenario = '1.3', d = outputs[[ind1.3]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/mort_scenario1.3_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```


#### Scenario 1.4

```{r, echo = FALSE, fig.align="center",fig.height = 12, fig.width = 12}

ind1.4 = grep('1.4', files)
if (length(ind1.4) == 1) {
  f = plot_mort(Scenario = '1.4', d = outputs[[ind1.4]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/mort_scenario1.3_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 2.1

```{r, echo = FALSE, fig.align="center",fig.height = 12, fig.width = 12}

ind2.1 = grep('2.1', files)
if (length(ind2.1) == 1) {
  f = plot_mort(Scenario = '2.1', d = outputs[[ind2.1]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/mort_scenario1.3_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 2.2

```{r, echo = FALSE, fig.align="center",fig.height = 12, fig.width = 12}

ind2.2 = grep('2.2', files)
if (length(ind2.2) == 1) {
  f = plot_mort(Scenario = '2.2', d = outputs[[ind2.2]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/mort_scenario1.3_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 2.3

```{r, echo = FALSE, fig.align="center",fig.height = 12, fig.width = 12}

ind2.3 = grep('2.3', files)
if (length(ind2.3) == 1) {
  f = plot_mort(Scenario = '2.3', d = outputs[[ind2.3]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/mort_scenario1.3_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```








#### Scenario 3.1

```{r, echo = FALSE, fig.align="center",fig.height = 12, fig.width = 12}

ind3.1 = grep('3.1', files)
if (length(ind3.1) == 1) {
  f = plot_mort(Scenario = '3.1', d = outputs[[ind3.1]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/mort_scenario1.3_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 3.2

```{r, echo = FALSE, fig.align="center",fig.height = 12, fig.width = 12}

ind3.2 = grep('3.2', files)
if (length(ind3.2) == 1) {
  f = plot_mort(Scenario = '3.2', d = outputs[[ind3.2]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/mort_scenario1.3_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 4.1

```{r, echo = FALSE, fig.align="center",fig.height = 12, fig.width = 12}

ind4.1 = grep('4.1', files)
if (length(ind4.1) == 1) {
  f = plot_mort(Scenario = '4.1', d = outputs[[ind4.1]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/mort_scenario1.3_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 4.2

```{r, echo = FALSE, fig.align="center",fig.height = 12, fig.width = 12}

ind4.2 = grep('4.2', files)
if (length(ind4.2) == 1) {
  f = plot_mort(Scenario = '4.2', d = outputs[[ind4.2]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/mort_scenario1.3_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 4.3

```{r, echo = FALSE, fig.align="center",fig.height = 12, fig.width = 12}

ind4.3 = grep('4.3', files)
if (length(ind4.3) == 1) {
  f = plot_mort(Scenario = '4.3', d = outputs[[ind4.3]])
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/mort_scenario1.3_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```


### Power

#### Scenario 1.2
Treatment B is better than treatments A, C and D: 
$T_B = 35\%$; and 
$T_j = 45\%$, $j = A, C, D$

```{r, echo = FALSE, fig.align="center",fig.height = 14, fig.width = 18}
ind1.2 = grep('1.2', files)
if (length(ind1.2) == 1) {
  
  power_filename = paste0('power_', sub('.*/', '', files[[ind1.2]]))
  if (power_filename %in% list.files('Code/Run_output/')) {
    # retrieve data if file already present 
    plot.d = readRDS(paste0(wd, 'Code/Run_output/', power_filename))
  } else {
    plot.d = get_type2(Scenario = '1.2', d = outputs[[ind1.2]])
    saveRDS(plot.d, paste0(wd, "Code/Run_output/power_", sub('.*/', '', files[[ind1.2]])))
  }
  # plot 
  f = plot_type2(Scenario = '1.2',plot.d)
  f
} else {
  message('There are no or multiple output files in `output`. Please select one.')
}


#ggsave(paste0(wd,"Code/Plots/type2_scenario1.2_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 1.3
All 4 treatments have different effects (small difference):
$T_A = 30\%$; $T_B = 35\%$; $T_C = 40\%$; $T_D = 45\%$

```{r, echo = FALSE, fig.align="center", fig.height = 14, fig.width = 18}

ind1.3 = grep('1.3', files)
if (length(ind1.3) == 1) {
  
  power_filename = paste0('power_', sub('.*/', '', files[[ind1.3]]))
  if (power_filename %in% list.files('Code/Run_output/')) {
    # retrieve data if file already present 
    plot.d = readRDS(paste0(wd, 'Code/Run_output/', power_filename))
  } else {
    plot.d = get_type2(Scenario = '1.3', d = outputs[[ind1.3]])
    saveRDS(plot.d, paste0(wd, "Code/Run_output/power_", sub('.*/', '', files[[ind1.3]])))
  }
  # plot 
  f = plot_type2(Scenario = '1.3', plot.d)
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}


#ggsave(paste0(wd,"Code/Plots/type2_scenario1.3_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```


#### Scenario 1.4

```{r, echo = FALSE, fig.align="center", fig.height = 14, fig.width = 18}

ind1.4 = grep('1.4', files)
if (length(ind1.4) == 1) {
  
  power_filename = paste0('power_', sub('.*/', '', files[[ind1.4]]))
  if (power_filename %in% list.files('Code/Run_output/')) {
    # retrieve data if file already present 
    plot.d = readRDS(paste0(wd, 'Code/Run_output/', power_filename))
  } else {
    plot.d = get_type2(Scenario = '1.4', d = outputs[[ind1.4]])
    saveRDS(plot.d, paste0(wd, "Code/Run_output/power_", sub('.*/', '', files[[ind1.4]])))
  }
  # plot 
  f = plot_type2(Scenario = '1.4', plot.d)
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}


#ggsave(paste0(wd,"Code/Plots/type2_scenario1.3_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```


#### Scenario 2.2

```{r, echo = FALSE, fig.align="center", fig.height = 14, fig.width = 18}

ind2.2 = grep('2.2', files)
if (length(ind2.2) == 1) {
  
  power_filename = paste0('power_', sub('.*/', '', files[[ind2.2]]))
  if (power_filename %in% list.files('Code/Run_output/')) {
    # retrieve data if file already present 
    plot.d = readRDS(paste0(wd, 'Code/Run_output/', power_filename))
  } else {
    plot.d = get_type2(Scenario = '2.2', d = outputs[[ind2.2]])
    saveRDS(plot.d, paste0(wd, "Code/Run_output/power_", sub('.*/', '', files[[ind2.2]])))
  }
  # plot 
  f = plot_type2(Scenario = '2.2', plot.d)
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}


#ggsave(paste0(wd,"Code/Plots/type2_scenario1.3_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```



#### Scenario 3.2

```{r, echo = FALSE, fig.align="center", fig.height = 14, fig.width = 18}

ind3.2 = grep('3.2', files)
if (length(ind3.2) == 1) {
  
  power_filename = paste0('power_', sub('.*/', '', files[[ind3.2]]))
  if (power_filename %in% list.files('Code/Run_output/')) {
    # retrieve data if file already present 
    plot.d = readRDS(paste0(wd, 'Code/Run_output/', power_filename))
  } else {
    plot.d = get_type2(Scenario = '3.2', d = outputs[[ind3.2]])
    saveRDS(plot.d, paste0(wd, "Code/Run_output/power_", sub('.*/', '', files[[ind3.2]])))
  }
  # plot 
  f = plot_type2(Scenario = '3.2', plot.d)
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}


#ggsave(paste0(wd,"Code/Plots/type2_scenario1.3_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 4.1

```{r, echo = FALSE, fig.align="center", fig.height = 14, fig.width = 18}

ind4.1 = grep('4.1', files)
if (length(ind4.1) == 1) {
  
  power_filename = paste0('power_', sub('.*/', '', files[[ind4.1]]))
  if (power_filename %in% list.files('Code/Run_output/')) {
    # retrieve data if file already present 
    plot.d = readRDS(paste0(wd, 'Code/Run_output/', power_filename))
  } else {
    plot.d = get_type2(Scenario = '4.1', d = outputs[[ind4.1]])
    saveRDS(plot.d, paste0(wd, "Code/Run_output/power_", sub('.*/', '', files[[ind4.1]])))
  }
  # plot 
  f = plot_type2(Scenario = '4.1', plot.d)
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}


#ggsave(paste0(wd,"Code/Plots/type2_scenario1.3_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

#### Scenario 4.2

```{r, echo = FALSE, fig.align="center", fig.height = 14, fig.width = 18}

ind4.2 = grep('4.2', files)
if (length(ind4.2) == 1) {
  
  power_filename = paste0('power_', sub('.*/', '', files[[ind4.2]]))
  if (power_filename %in% list.files('Code/Run_output/')) {
    # retrieve data if file already present 
    plot.d = readRDS(paste0(wd, 'Code/Run_output/', power_filename))
  } else {
    plot.d = get_type2(Scenario = '4.2', d = outputs[[ind4.2]])
    saveRDS(plot.d, paste0(wd, "Code/Run_output/power_", sub('.*/', '', files[[ind4.2]])))
  }
  # plot 
  f = plot_type2(Scenario = '4.2', plot.d)
  f
} else {
  message('There are multiple output files in `output`. Please select one.')
}


#ggsave(paste0(wd,"Code/Plots/type2_scenario1.3_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```


### Type 1 error

#### Scenario 1.1

```{r, echo = FALSE, fig.align="center",fig.height = 14, fig.width = 18}

ind1.1 = grep('1.1', files)
if (length(ind1.1) == 1) {
  
  t1_filename = paste0('t1_', sub('.*/', '', files[[ind1.1]]))
  if (t1_filename %in% list.files('Code/Run_output/')) {
    # retrieve data if file already present 
    plot.d = readRDS(paste0(wd, 'Code/Run_output/', t1_filename))
  } else {
    plot.d = get_type1(Scenario = '1.1', d = outputs[[ind1.1]])
    saveRDS(plot.d, paste0(wd, "Code/Run_output/t1_", sub('.*/', '', files[[ind1.1]])))
  }
  # plot 
  f = plot_type1(plot.d)
  f
} else {
  message('There are no or multiple output files in `output`. Please select one.')
}

#ggsave(paste0(wd,"Code/Plots/type1_scenario1.1_", Sys.Date(), ".pdf"), f, width = 8, height = 7)

```

### Running time

```{r, echo = FALSE, fig.align="center",fig.height = 14, fig.width = 18}
# plot running time
files_timing = list.files(path = paste0(wd, 'Code/Run_output'), full.names = TRUE, pattern = "^timing_")
scenario = substr(sub(".*_","",files_timing),1,3)
outputs_timing = rep(NA,length(scenario))

for (i in 1:length(scenario)){
  outputs_timing[i] = readRDS(files_timing[i])
}

plot_timing(Scenario = scenario, Timing=outputs_timing)
```